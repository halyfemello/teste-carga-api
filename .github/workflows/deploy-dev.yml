name: Deploy Dev

on:
  push:
    branches: [develop]

jobs:
  deploy:
    name: Build and Deploy to VPS
    runs-on: ubuntu-latest

    env:
      VPS_HOST: 195.200.1.129
      VPS_USER: root
      IMAGE_NAME: minhaapi:latest
      TAR_FILE: minhaapi.tar
      REMOTE_DIR: /root/services/minhaapi

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build da imagem Docker
        run: docker build -t $IMAGE_NAME -f ./Dockerfile .

      - name: Exportar imagem para tar
        run: docker save -o $TAR_FILE $IMAGE_NAME

      - name: Instalar SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Adicionar VPS ao known_hosts
        run: |
          ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts

      - name: Enviar arquivos para VPS
        run: |
          echo "ðŸ“¤ Enviando imagem e docker-compose.yml para VPS..."
          scp $TAR_FILE $VPS_USER@$VPS_HOST:$REMOTE_DIR/
          scp docker-compose.yml $VPS_USER@$VPS_HOST:$REMOTE_DIR/

      # - name: Verificar arquivos disponÃ­veis
      #   run: ls -la $GITHUB_WORKSPACE

      # - name: Enviar arquivos para VPS via SCP
      #   run: |
      #     scp $TAR_FILE $VPS_USER@$VPS_HOST:$REMOTE_PATH/
      #     scp $GITHUB_WORKSPACE/infra/dev/docker-compose.yml $VPS_USER@$VPS_HOST:$REMOTE_PATH/infra/dev/docker-compose.yml

      - name: Executar deploy remoto via SSH
        run: |
          ssh $VPS_USER@$VPS_HOST << EOF
            set -e
            echo "ðŸ›‘ Parando container antigo se existir..."
            docker stop api-teste || true
            docker rm api-teste || true

            echo "ðŸ§¼ Removendo imagem antiga..."
            docker rmi -f minhaapi:latest || true

            echo "ðŸ“¦ Subindo aplicaÃ§Ã£o..."
            cd $REMOTE_DIR
            docker load -i $TAR_FILE
            docker compose up -d

            echo "âœ… Deploy finalizado!"
          EOF
